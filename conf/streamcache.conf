server {
    listen 8080;
    server_name _;

    # Serve committed cached files directly; supports Range natively
    location /cache/ {
        internal;
        alias /var/cache/streamcache/files/;
        add_header Accept-Ranges bytes always;
    }

    # Main endpoint: /u/<BASE64URL-ENCODED-ORIGINAL-URL>
    location ~ ^/u/(?<b64>[-_A-Za-z0-9=]+)$ {
        content_by_lua_file /etc/openresty/streamcache.lua;
    }

    # Optional internal passthrough (not used by main flow; kept for future)
    location @passthrough {
        internal;
        return 404;
    }
}
